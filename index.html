<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>NIT Trichy Buggy Map</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        html, body, #map { height:100%; margin:0; padding:0; }
        body { font-family: Arial, sans-serif; }

        .topbar {
          position: absolute; left:12px; top:12px; z-index:1000;
          background: rgba(0,0,0,0.45); color:white;
          padding:8px 12px; border-radius:10px;
          font-size:14px; backdrop-filter: blur(4px);
        }

        .nearest-stop {
           border: 3px solid yellow !important;
           border-radius: 50%;
        }

        .buggy-icon { 
          width: 48px; height: 48px; 
          transform-origin: center; 
        }
    </style>
</head>

<body>
<div id="map"></div>
<div class="topbar" id="status">Loading map…</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/*******************************************
 *  FIREBASE CONFIG — YOU MUST REPLACE THIS
 *******************************************/
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/*******************************************
 *  OPENROUTESERVICE CONFIG
 *******************************************/
const ORS_API_KEY = "YOUR_ORS_API_KEY_HERE";
const ORS_URL = "https://api.openrouteservice.org/v2/directions/driving-car";

/*******************************************/
const statusEl = document.getElementById("status");
function setStatus(t){ statusEl.textContent = t; }

/*******************************************
 *  MAP
 *******************************************/
const map = L.map("map").setView([10.7600, 78.8135], 16);

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
}).addTo(map);

/*******************************************
 * STOP ICON (SAFE URL)
 *******************************************/
const stopIcon = L.icon({
  iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41]
});

/*******************************************
 * STOP LIST
 *******************************************/
const buggyStops = [
  { name: 'Lassi Shop', location: [10.761750, 78.814649] },
  { name: 'Coke Station', location: [10.761701, 78.813969] },
  { name: 'GJCH', location: [10.761515, 78.811831] },
];

/*******************************************
 * CREATE STOP MARKERS
 *******************************************/
const stopMarkers = [];

buggyStops.forEach(stop => {
  const marker = L.marker(stop.location, {icon: stopIcon})
    .addTo(map)
    .bindPopup(`<b>${stop.name}</b>`);

  stopMarkers.push({ marker, data: stop });
});

function findStopByName(n) {
  return buggyStops.find(s => 
    s.name.toLowerCase() === n.toLowerCase()
  );
}

function findNearestStop(lat,lng) {
  let min = Infinity, nearest = null;
  stopMarkers.forEach(m => {
    const d = map.distance([lat,lng], m.data.location);
    if (d < min) { min = d; nearest = m; }
  });
  return nearest;
}

/*******************************************
 * BUGGY MARKERS (LIVE)
 *******************************************/
const busIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/61/61214.png",
  iconSize: [48,48],
  iconAnchor: [24,24]
});

const buggyMarkers = {};

function rotateIcon(marker, heading) {
  if (marker._icon) {
    marker._icon.style.transform =
      `translate(-50%, -50%) rotate(${heading}deg)`;
  }
}

function smoothMove(marker, targetLatLng) {
  const start = marker.getLatLng();
  const end = L.latLng(targetLatLng);
  let i = 0, steps = 20;

  function animate() {
    i++;
    const lat = start.lat + (end.lat-start.lat)*(i/steps);
    const lng = start.lng + (end.lng-start.lng)*(i/steps);
    marker.setLatLng([lat,lng]);

    if (i < steps) requestAnimationFrame(animate);
  }
  animate();
}

db.collection("buggies").onSnapshot(snap => {
  snap.forEach(doc => {
    const d = doc.data();
    if (!d.lat || !d.lng) return;

    if (!buggyMarkers[doc.id]) {
      buggyMarkers[doc.id] = L.marker([d.lat,d.lng], {icon: busIcon})
        .addTo(map);
    } else {
      smoothMove(buggyMarkers[doc.id], [d.lat, d.lng]);
    }
    rotateIcon(buggyMarkers[doc.id], d.heading || 0);
  });
});

/*******************************************
 * USER MARKER
 *******************************************/
let userMarker = null;
function updateUser(lat, lng, name) {
  if (!userMarker) {
    userMarker = L.marker([lat,lng], {
      icon: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/149/149071.png",
        iconSize: [40,40]
      })
    }).addTo(map);
  } else {
    smoothMove(userMarker, [lat,lng]);
  }
}

/*******************************************
 * ROUTE FUNCTION (SAFE)
 *******************************************/
async function getRoute(from, to) {
  if (!ORS_API_KEY || ORS_API_KEY === "YOUR_ORS_API_KEY_HERE") {
    console.warn("ORS key missing, drawing straight line.");
    return { route: [from, to], distanceKm: 0, durationMin: 0 };
  }

  try {
    const url = `${ORS_URL}?api_key=${ORS_API_KEY}&start=${from[1]},${from[0]}&end=${to[1]},${to[0]}`;
    const res = await fetch(url);

    const data = await res.json();
    const coords = data.features[0].geometry.coordinates;

    const route = coords.map(c => [c[1], c[0]]);
    const s = data.features[0].properties.summary;

    return {
      route,
      distanceKm: s.distance / 1000,
      durationMin: s.duration / 60
    };
  } catch(e) {
    console.error("ORS failed:", e);
    return { route: [from, to], distanceKm: 0, durationMin: 0 };
  }
}

/*******************************************
 * THUNKABLE MESSAGE LISTENER (WORKS NOW)
 *******************************************/
window.addEventListener("message", async evt => {
  let d = evt.data;
  if (typeof d === "string") try { d = JSON.parse(d); } catch (_) {}

  // Update user location
  if (d.lat && d.lng) {
    updateUser(d.lat, d.lng, d.name);
    const nearest = findNearestStop(d.lat, d.lng);

    stopMarkers.forEach(s => 
      s.marker._icon.classList.remove("nearest-stop")
    );
    nearest.marker._icon.classList.add("nearest-stop");
  }

  // Pickup + drop route
  if (d.pickup && d.drop) {
    const p = findStopByName(d.pickup);
    const q = findStopByName(d.drop);
    if (!p || !q) return;

    const result = await getRoute(p.location, q.location);

    if (window.routeLine) map.removeLayer(window.routeLine);

    window.routeLine = L.polyline(result.route, {
      color: "red", weight: 5
    }).addTo(map);

    map.fitBounds(window.routeLine.getBounds(), { padding: [40,40] });
  }
});

window.onload = () => {
  window.parent.postMessage(JSON.stringify({ready:true}), "*");
  setStatus("Ready…");
};
</script>

</body>
</html>
